---
###############################################################################
#
# Ansible Playbook generated from evaluation of CIS SUSE Linux Enterprise 15 Benchmark for Level 1 - Server [CUSTOMIZED]
#
# Profile ID: xccdf_org.ssgproject.content_profile_cis_server_l1_cusBTG
# XCCDF Version:  1.2
#
# Evaluation Start Time:  2024-11-12T03:26:28+00:00
# Evaluation End Time:  2024-11-12T03:26:28+00:00
#
# This file was generated by OpenSCAP 1.3.6 using:
# $ oscap xccdf generate fix --result-id xccdf_org.open-scap_testresult_xccdf_org.ssgproject.content_profile_cis_server_l1_cusBTG --fix-type ansible xccdf-results.xml
#
# This Ansible Playbook is generated from the results of a profile evaluation.
# It attempts to remediate all issues from the selected rules that failed the test.
#
# How to apply this Ansible Playbook:
# $ ansible-playbook -i "localhost," -c local playbook.yml
# $ ansible-playbook -i "192.168.1.155," playbook.yml
# $ ansible-playbook -i inventory.ini playbook.yml
#
###############################################################################


- hosts: all
  vars:
    var_sudo_logfile: !!str /var/log/sudo.log
    var_password_pam_remember: !!str 5
    var_password_pam_tally2: !!str 5
    var_accounts_passwords_pam_tally2_unlock_time: !!str 600
    var_password_pam_dcredit: !!str -1
    var_password_pam_difok: !!str 8
    var_password_pam_lcredit: !!str -1
    var_password_pam_minlen: !!str 14
    var_password_pam_ocredit: !!str -1
    var_password_pam_retry: !!str 3
    var_password_pam_ucredit: !!str -1
    var_password_pam_minclass: !!str 3
    var_accounts_maximum_age_login_defs: !!str 180
    var_accounts_minimum_age_login_defs: !!str 1
    var_auditd_max_log_file: !!str 10
  tasks:
    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-91311-1
      - PCI-DSS-Req-10.2.5
      - PCI-DSSv4-2.2.6
      - low_complexity
      - low_disruption
      - low_severity
      - no_reboot_needed
      - restrict_strategy
      - sudo_custom_logfile



    - name: Ensure logfile is enabled with the appropriate value in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        regexp: ^[\s]*Defaults\s(.*)\blogfile=[-]?.+\b(.*)$
        line: Defaults \1logfile={{ var_sudo_logfile }}\2
        validate: /usr/sbin/visudo -cf %s
        backrefs: true
      register: edit_sudoers_logfile_option
      when: '"sudo" in ansible_facts.packages'
      tags:
      - CCE-91311-1
      - PCI-DSS-Req-10.2.5
      - PCI-DSSv4-2.2.6
      - low_complexity
      - low_disruption
      - low_severity
      - no_reboot_needed
      - restrict_strategy
      - sudo_custom_logfile

    - name: Enable logfile option with appropriate value in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        line: Defaults logfile={{ var_sudo_logfile }}
        validate: /usr/sbin/visudo -cf %s
      when:
      - '"sudo" in ansible_facts.packages'
      - edit_sudoers_logfile_option is defined and not edit_sudoers_logfile_option.changed
      tags:
      - CCE-91311-1
      - PCI-DSS-Req-10.2.5
      - PCI-DSSv4-2.2.6
      - low_complexity
      - low_disruption
      - low_severity
      - no_reboot_needed
      - restrict_strategy
      - sudo_custom_logfile


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy



    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_pwhistory.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_pwhistory.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_pwhistory.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_pwhistory.so
        state: present
      when:
      - '"pam" in ansible_facts.packages'
      - check_pam_module_result.stdout is defined and '"pam_pwhistory.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_pwhistory.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_pwhistory.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when:
      - '"pam" in ansible_facts.packages'
      - control_flag|length
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_pwhistory.so" module has argument "remember={{ var_password_pam_remember
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_pwhistory.so(?:\s+\S+)*\s+remember=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_remember }}\g<2>
        backrefs: true
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "remember" argument in "pam_pwhistory.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_pwhistory.so.*\s+remember(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "remember" argument to "pam_pwhistory.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_pwhistory.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> remember={{ var_password_pam_remember }}\g<2>
        backrefs: true
      when:
      - '"pam" in ansible_facts.packages'
      - check_pam_module_argument_result is not skipped and '"remember" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set argument_value fact
      set_fact:
        argument_value: ''
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_pwhistory.so" module has argument "use_authtok"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_pwhistory.so(?:\s+\S+)*\s+use_authtok=)(?!)\S*((\s+\S+)*\s*\\*\s*)$
        line: \g<1>\g<2>
        backrefs: true
      when:
      - '"pam" in ansible_facts.packages'
      - argument_value|length
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "use_authtok" argument in "pam_pwhistory.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_pwhistory.so.*\s+use_authtok(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "use_authtok" argument to "pam_pwhistory.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_pwhistory.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> use_authtok\g<2>
        backrefs: true
      when:
      - '"pam" in ansible_facts.packages'
      - check_pam_module_argument_result is not skipped and '"use_authtok" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-91398-8
      - accounts_password_pam_pwhistory_remember
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed



    - name: Set Deny For Failed Password Attempts - Check if expected PAM module line
        is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_line_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Include or update the PAM module line
        in /etc/pam.d/login
      block:

      - name: Set Deny For Failed Password Attempts - Check if required PAM module line
          is present in /etc/pam.d/login with different control
        ansible.builtin.lineinfile:
          path: /etc/pam.d/login
          regexp: ^\s*auth\s+.*\s+pam_tally2.so\s*
          state: absent
        check_mode: true
        changed_when: false
        register: result_pam_line_other_control_present

      - name: Set Deny For Failed Password Attempts - Ensure the correct control for the
          required PAM module line in /etc/pam.d/login
        ansible.builtin.replace:
          dest: /etc/pam.d/login
          regexp: ^(\s*auth\s+).*(\bpam_tally2.so.*)
          replace: \1required \2
        register: result_pam_module_edit
        when:
        - result_pam_line_other_control_present.found == 1

      - name: Set Deny For Failed Password Attempts - Ensure the required PAM module line
          is included in /etc/pam.d/login
        ansible.builtin.lineinfile:
          dest: /etc/pam.d/login
          line: auth    required    pam_tally2.so
        register: result_pam_module_add
        when:
        - result_pam_line_other_control_present.found == 0 or result_pam_line_other_control_present.found
          > 1

      - name: Set Deny For Failed Password Attempts - Ensure authselect changes are applied
        ansible.builtin.command:
          cmd: authselect apply-changes -b
        when:
        - result_authselect_present is defined
        - result_authselect_present.stat.exists
        - |-
          (result_pam_module_add is defined and result_pam_module_add.changed)
           or (result_pam_module_edit is defined and result_pam_module_edit.changed)
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_line_present.found is defined
      - result_pam_line_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Check if the required PAM module option
        is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*\sdeny\b
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_module_deny_option_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Ensure the "deny" PAM option for "pam_tally2.so"
        is included in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so.*)
        line: \1 deny={{ var_password_pam_tally2 }}
        state: present
      register: result_pam_deny_add
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_deny_option_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Ensure the required value for "deny"
        PAM option from "pam_tally2.so" in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s+.*)(deny)=[0-9a-zA-Z]+\s*(.*)
        line: \1\2={{ var_password_pam_tally2 }} \3
      register: result_pam_deny_edit
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_deny_option_present.found > 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Check if expected PAM module line
        is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_line_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Include or update the PAM module line
        in /etc/pam.d/login
      block:

      - name: Set Deny For Failed Password Attempts - Check if required PAM module line
          is present in /etc/pam.d/login with different control
        ansible.builtin.lineinfile:
          path: /etc/pam.d/login
          regexp: ^\s*auth\s+.*\s+pam_tally2.so\s*
          state: absent
        check_mode: true
        changed_when: false
        register: result_pam_line_other_control_present

      - name: Set Deny For Failed Password Attempts - Ensure the correct control for the
          required PAM module line in /etc/pam.d/login
        ansible.builtin.replace:
          dest: /etc/pam.d/login
          regexp: ^(\s*auth\s+).*(\bpam_tally2.so.*)
          replace: \1required \2
        register: result_pam_module_edit
        when:
        - result_pam_line_other_control_present.found == 1

      - name: Set Deny For Failed Password Attempts - Ensure the required PAM module line
          is included in /etc/pam.d/login
        ansible.builtin.lineinfile:
          dest: /etc/pam.d/login
          insertafter: (fail)
          line: auth    required    pam_tally2.so
        register: result_pam_module_add
        when:
        - result_pam_line_other_control_present.found == 0 or result_pam_line_other_control_present.found
          > 1

      - name: Set Deny For Failed Password Attempts - Ensure authselect changes are applied
        ansible.builtin.command:
          cmd: authselect apply-changes -b
        when:
        - result_authselect_present is defined
        - result_authselect_present.stat.exists
        - |-
          (result_pam_module_add is defined and result_pam_module_add.changed)
           or (result_pam_module_edit is defined and result_pam_module_edit.changed)
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_line_present.found is defined
      - result_pam_line_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Check if the required PAM module option
        is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*\sonerr\b
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_module_onerr_option_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Ensure the "onerr" PAM option for
        "pam_tally2.so" is included in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so.*)
        line: \1 onerr=fail
        state: present
      register: result_pam_onerr_add
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_onerr_option_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Ensure the required value for "onerr"
        PAM option from "pam_tally2.so" in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s+.*)(onerr)=[0-9a-zA-Z]+\s*(.*)
        line: \1\2=fail \3
      register: result_pam_onerr_edit
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_onerr_option_present.found > 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Check if expected PAM module line
        is present in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        regexp: ^\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_line_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Include or update the PAM module line
        in /etc/pam.d/common-account
      block:

      - name: Set Deny For Failed Password Attempts - Check if required PAM module line
          is present in /etc/pam.d/common-account with different control
        ansible.builtin.lineinfile:
          path: /etc/pam.d/common-account
          regexp: ^\s*account\s+.*\s+pam_tally2.so\s*
          state: absent
        check_mode: true
        changed_when: false
        register: result_pam_line_other_control_present

      - name: Set Deny For Failed Password Attempts - Ensure the correct control for the
          required PAM module line in /etc/pam.d/common-account
        ansible.builtin.replace:
          dest: /etc/pam.d/common-account
          regexp: ^(\s*account\s+).*(\bpam_tally2.so.*)
          replace: \1required \2
        register: result_pam_module_edit
        when:
        - result_pam_line_other_control_present.found == 1

      - name: Set Deny For Failed Password Attempts - Ensure the required PAM module line
          is included in /etc/pam.d/common-account
        ansible.builtin.lineinfile:
          dest: /etc/pam.d/common-account
          line: account    required    pam_tally2.so
        register: result_pam_module_add
        when:
        - result_pam_line_other_control_present.found == 0 or result_pam_line_other_control_present.found
          > 1

      - name: Set Deny For Failed Password Attempts - Ensure authselect changes are applied
        ansible.builtin.command:
          cmd: authselect apply-changes -b
        when:
        - result_authselect_present is defined
        - result_authselect_present.stat.exists
        - |-
          (result_pam_module_add is defined and result_pam_module_add.changed)
           or (result_pam_module_edit is defined and result_pam_module_edit.changed)
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_line_present.found is defined
      - result_pam_line_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Check if the required PAM module option
        is present in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        regexp: ^\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*\s\b
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_module__option_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed

    - name: Set Deny For Failed Password Attempts - Ensure the "" PAM option for "pam_tally2.so"
        is included in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        backrefs: true
        regexp: ^(\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so.*)
        line: \1
        state: present
      register: result_pam__add
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module__option_present.found == 0
      tags:
      - CCE-85554-4
      - DISA-STIG-SLES-15-020010
      - PCI-DSS-Req-8.1.6
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2
      - configure_strategy
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy



    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
        expected PAM module line is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_line_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Include or
        update the PAM module line in /etc/pam.d/login
      block:

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
          required PAM module line is present in /etc/pam.d/login with different control
        ansible.builtin.lineinfile:
          path: /etc/pam.d/login
          regexp: ^\s*auth\s+.*\s+pam_tally2.so\s*
          state: absent
        check_mode: true
        changed_when: false
        register: result_pam_line_other_control_present

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          the correct control for the required PAM module line in /etc/pam.d/login
        ansible.builtin.replace:
          dest: /etc/pam.d/login
          regexp: ^(\s*auth\s+).*(\bpam_tally2.so.*)
          replace: \1required \2
        register: result_pam_module_edit
        when:
        - result_pam_line_other_control_present.found == 1

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          the required PAM module line is included in /etc/pam.d/login
        ansible.builtin.lineinfile:
          dest: /etc/pam.d/login
          line: auth    required    pam_tally2.so
        register: result_pam_module_add
        when:
        - result_pam_line_other_control_present.found == 0 or result_pam_line_other_control_present.found
          > 1

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          authselect changes are applied
        ansible.builtin.command:
          cmd: authselect apply-changes -b
        when:
        - result_authselect_present is defined
        - result_authselect_present.stat.exists
        - |-
          (result_pam_module_add is defined and result_pam_module_add.changed)
           or (result_pam_module_edit is defined and result_pam_module_edit.changed)
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_line_present.found is defined
      - result_pam_line_present.found == 0
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
        the required PAM module option is present in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        regexp: ^\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*\sunlock_time\b
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_module_unlock_time_option_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure the
        "unlock_time" PAM option for "pam_tally2.so" is included in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so.*)
        line: \1 unlock_time={{ var_accounts_passwords_pam_tally2_unlock_time }}
        state: present
      register: result_pam_unlock_time_add
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_unlock_time_option_present.found == 0
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure the
        required value for "unlock_time" PAM option from "pam_tally2.so" in /etc/pam.d/login
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        backrefs: true
        regexp: ^(\s*auth\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s+.*)(unlock_time)=[0-9a-zA-Z]+\s*(.*)
        line: \1\2={{ var_accounts_passwords_pam_tally2_unlock_time }} \3
      register: result_pam_unlock_time_edit
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module_unlock_time_option_present.found > 0
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
        expected PAM module line is present in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        regexp: ^\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_line_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Include or
        update the PAM module line in /etc/pam.d/common-account
      block:

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
          required PAM module line is present in /etc/pam.d/common-account with different
          control
        ansible.builtin.lineinfile:
          path: /etc/pam.d/common-account
          regexp: ^\s*account\s+.*\s+pam_tally2.so\s*
          state: absent
        check_mode: true
        changed_when: false
        register: result_pam_line_other_control_present

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          the correct control for the required PAM module line in /etc/pam.d/common-account
        ansible.builtin.replace:
          dest: /etc/pam.d/common-account
          regexp: ^(\s*account\s+).*(\bpam_tally2.so.*)
          replace: \1required \2
        register: result_pam_module_edit
        when:
        - result_pam_line_other_control_present.found == 1

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          the required PAM module line is included in /etc/pam.d/common-account
        ansible.builtin.lineinfile:
          dest: /etc/pam.d/common-account
          line: account    required    pam_tally2.so
        register: result_pam_module_add
        when:
        - result_pam_line_other_control_present.found == 0 or result_pam_line_other_control_present.found
          > 1

      - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure
          authselect changes are applied
        ansible.builtin.command:
          cmd: authselect apply-changes -b
        when:
        - result_authselect_present is defined
        - result_authselect_present.stat.exists
        - |-
          (result_pam_module_add is defined and result_pam_module_add.changed)
           or (result_pam_module_edit is defined and result_pam_module_edit.changed)
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_line_present.found is defined
      - result_pam_line_present.found == 0
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Check if
        the required PAM module option is present in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        regexp: ^\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so\s*.*\s\b
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_module__option_present
      when: '"pam" in ansible_facts.packages'
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Set Lockout Time for Failed Password Attempts using pam_tally2 - Ensure the
        "" PAM option for "pam_tally2.so" is included in /etc/pam.d/common-account
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-account
        backrefs: true
        regexp: ^(\s*account\s+{{ 'required' | regex_escape() }}\s+pam_tally2.so.*)
        line: \1
        state: present
      register: result_pam__add
      when:
      - '"pam" in ansible_facts.packages'
      - result_pam_module__option_present.found == 0
      tags:
      - CCE-91282-4
      - NIST-800-53-AC-7(b)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(c)
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - accounts_passwords_pam_tally2_unlock_time
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "dcredit={{ var_password_pam_dcredit
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+dcredit=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_dcredit }}\g<2>
        backrefs: true
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "dcredit" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+dcredit(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "dcredit" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> dcredit={{ var_password_pam_dcredit }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"dcredit" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85564-3
      - DISA-STIG-SLES-15-020150
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_dcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "difok={{ var_password_pam_difok
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+difok=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_difok }}\g<2>
        backrefs: true
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "difok" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+difok(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "difok" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> difok={{ var_password_pam_difok }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"difok" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85677-3
      - DISA-STIG-SLES-15-020160
      - NIST-800-53-IA-5(1)(b)
      - NIST-800-53-IA-5(1).1(v)
      - cracklib_accounts_password_pam_difok
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "lcredit={{ var_password_pam_lcredit
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+lcredit=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_lcredit }}\g<2>
        backrefs: true
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "lcredit" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+lcredit(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "lcredit" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> lcredit={{ var_password_pam_lcredit }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"lcredit" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85676-5
      - DISA-STIG-SLES-15-020140
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_lcredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "minlen={{ var_password_pam_minlen
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+minlen=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_minlen }}\g<2>
        backrefs: true
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "minlen" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+minlen(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "minlen" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> minlen={{ var_password_pam_minlen }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"minlen" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85573-4
      - DISA-STIG-SLES-15-020260
      - PCI-DSS-Req-8.2.3
      - PCI-DSSv4-8.3.6
      - cracklib_accounts_password_pam_minlen
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "ocredit={{ var_password_pam_ocredit
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+ocredit=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_ocredit }}\g<2>
        backrefs: true
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "ocredit" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+ocredit(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "ocredit" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> ocredit={{ var_password_pam_ocredit }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"ocredit" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85574-2
      - DISA-STIG-SLES-15-020270
      - NIST-800-53-IA-5(a)
      - NIST-800-53-IA-5(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ocredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "retry={{ var_password_pam_retry
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+retry=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_retry }}\g<2>
        backrefs: true
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "retry" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+retry(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "retry" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> retry={{ var_password_pam_retry }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"retry" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85575-9
      - DISA-STIG-SLES-15-020290
      - PCI-DSS-Req-8.1.6
      - PCI-DSS-Req-8.1.7
      - PCI-DSSv4-8.3.4
      - cracklib_accounts_password_pam_retry
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Set control_flag fact
      set_fact:
        control_flag: requisite
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check to see if 'pam_cracklib.so' module is configured in '/etc/pam.d/common-password'
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+\S+\s+pam_cracklib.so' /etc/pam.d/common-password || true
      register: check_pam_module_result
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Configure 'pam_cracklib.so' module in '/etc/pam.d/common-password'
      lineinfile:
        path: /etc/pam.d/common-password
        line: password requisite pam_cracklib.so
        state: present
      when: check_pam_module_result.stdout is defined and '"pam_cracklib.so" not in check_pam_module_result.stdout'
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure 'pam_cracklib.so' module has conforming control flag
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+)\S+(\s+pam_cracklib.so\s+.*)
        line: \g<1>requisite\g<2>
        backrefs: true
      when: control_flag|length
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Ensure "pam_cracklib.so" module has argument "ucredit={{ var_password_pam_ucredit
        }}"
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so(?:\s+\S+)*\s+ucredit=)(?:\S+)((\s+\S+)*\s*\\*\s*)$
        line: \g<1>{{ var_password_pam_ucredit }}\g<2>
        backrefs: true
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Check the presence of "ucredit" argument in "pam_cracklib.so" module
      shell: |
        set -o pipefail
        grep -E '^\s*password\s+requisite\s+pam_cracklib.so.*\s+ucredit(=|\s|\s*$)' /etc/pam.d/common-password || true
      register: check_pam_module_argument_result
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Add "ucredit" argument to "pam_cracklib.so" module
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: ^(\s*password\s+requisite\s+pam_cracklib.so)((\s+\S+)*\s*(\\)*$)
        line: \g<1> ucredit={{ var_password_pam_ucredit }}\g<2>
        backrefs: true
      when: check_pam_module_argument_result is not skipped and '"ucredit" not in check_pam_module_argument_result.stdout'
      tags:
      - CCE-85675-7
      - DISA-STIG-SLES-15-020130
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(1).1(v)
      - PCI-DSS-Req-8.2.3
      - cracklib_accounts_password_pam_ucredit
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(4)
      - NIST-800-53-IA-5(c)
      - accounts_password_pam_minclass
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy



    - name: Ensure PAM Enforces Password Requirements - Minimum Different Categories -
        Ensure PAM variable minclass is set accordingly
      ansible.builtin.lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minclass
        line: minclass = {{ var_password_pam_minclass }}
      when: '"pam" in ansible_facts.packages'
      tags:
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(4)
      - NIST-800-53-IA-5(c)
      - accounts_password_pam_minclass
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Collect users with not correct maximum time period between password changes
      ansible.builtin.command:
        cmd: awk -F':' '(/^[^:]+:[^!*]/ && ($5 > {{ var_accounts_maximum_age_login_defs
          }} || $5 == "")) {print $1}' /etc/shadow
      register: user_names
      tags:
      - CCE-85571-8
      - DISA-STIG-SLES-15-020230
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(d)
      - NIST-800-53-IA-5(f)
      - PCI-DSSv4-8.3.9
      - accounts_password_set_max_life_existing
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Change the maximum time period between password changes
      ansible.builtin.command:
        cmd: passwd -q -x {{ var_accounts_maximum_age_login_defs }} {{ item }}
      with_items: '{{ user_names.stdout_lines }}'
      when: user_names.stdout_lines | length > 0
      tags:
      - CCE-85571-8
      - DISA-STIG-SLES-15-020230
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(d)
      - NIST-800-53-IA-5(f)
      - PCI-DSSv4-8.3.9
      - accounts_password_set_max_life_existing
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy





    - name: Collect users with not correct minimum time period between password changes
      command: |
        awk -F':' '(/^[^:]+:[^!*]/ && ($4 < {{ var_accounts_minimum_age_login_defs }} || $4 == "")) {print $1}' /etc/shadow
      register: user_names
      tags:
      - CCE-85710-2
      - DISA-STIG-SLES-15-020210
      - NIST-800-53-IA-5(1).1(v)
      - accounts_password_set_min_life_existing
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy

    - name: Change the minimum time period between password changes
      command: |
        passwd -q -n {{ var_accounts_minimum_age_login_defs }} {{ item }}
      with_items: '{{ user_names.stdout_lines }}'
      when: user_names.stdout_lines | length > 0
      tags:
      - CCE-85710-2
      - DISA-STIG-SLES-15-020210
      - NIST-800-53-IA-5(1).1(v)
      - accounts_password_set_min_life_existing
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Check ipv6.disable argument exists
      command: grep '^\s*GRUB_CMDLINE_LINUX=.*ipv6.disable=' /etc/default/grub
      failed_when: false
      register: argcheck
      when: '"grub2" in ansible_facts.packages'
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Check ipv6.disable argument exists
      command: grep '^\s*GRUB_CMDLINE_LINUX=' /etc/default/grub
      failed_when: false
      register: linecheck
      when: '"grub2" in ansible_facts.packages'
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Add ipv6.disable argument
      ansible.builtin.lineinfile:
        line: GRUB_CMDLINE_LINUX="ipv6.disable=1 "
        state: present
        dest: /etc/default/grub
        create: true
        mode: '0644'
      when:
      - '"grub2" in ansible_facts.packages'
      - argcheck is not skipped and linecheck is not skipped and argcheck.rc != 0 and
        linecheck.rc != 0
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Replace existing ipv6.disable argument
      replace:
        path: /etc/default/grub
        regexp: ipv6.disable=[a-zA-Z0-9,]+
        replace: ipv6.disable=1
      when:
      - '"grub2" in ansible_facts.packages'
      - argcheck is not skipped and linecheck is not skipped and argcheck.rc == 0 and
        linecheck.rc == 0
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Add ipv6.disable argument
      replace:
        path: /etc/default/grub
        regexp: (^\s*GRUB_CMDLINE_LINUX=.*)"
        replace: \1 ipv6.disable=1"
      when:
      - '"grub2" in ansible_facts.packages'
      - argcheck is not skipped and linecheck is not skipped and argcheck.rc != 0 and
        linecheck.rc == 0
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy

    - name: Update grub defaults and the bootloader menu
      command: /usr/sbin/grub2-mkconfig -o /boot/grub2/grub.cfg
      when: '"grub2" in ansible_facts.packages'
      tags:
      - CCE-91240-2
      - PCI-DSS-Req-1.3.1
      - PCI-DSS-Req-1.3.2
      - grub2_ipv6_disable_argument
      - low_disruption
      - low_severity
      - medium_complexity
      - reboot_required
      - restrict_strategy


    - name: Disable IPv6 Networking kernel module
      lineinfile:
        create: true
        dest: /etc/modprobe.d/ipv6.conf
        regexp: ^options\s+ipv6\s+disable=\d
        line: options ipv6 disable=1
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_ipv6_option_disabled
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required

    - name: Ensure disable_ipv6 (all and default) is set to 1
      sysctl:
        name: '{{ item }}'
        value: '1'
        state: present
        reload: true
      with_items:
      - net.ipv6.conf.all.disable_ipv6
      - net.ipv6.conf.default.disable_ipv6
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_ipv6_option_disabled
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required


    - name: List /etc/sysctl.d/*.conf files
      find:
        paths:
        - /run/sysctl.d/
        - /etc/sysctl.d/
        - /usr/local/lib/sysctl.d/
        - /lib/sysctl.d/
        contains: ^[\s]*net.ipv6.conf.all.disable_ipv6.*$
        patterns: '*.conf'
        file_type: any
      register: find_sysctl_d
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92496-9
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_all_disable_ipv6

    - name: Comment out any occurrences of net.ipv6.conf.all.disable_ipv6 from config
        files
      replace:
        path: '{{ item.path }}'
        regexp: ^[\s]*net.ipv6.conf.all.disable_ipv6
        replace: '#net.ipv6.conf.all.disable_ipv6'
      loop: '{{ find_sysctl_d.files }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92496-9
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_all_disable_ipv6

    - name: Comment out any occurrences of net.ipv6.conf.all.disable_ipv6 from /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: ^[\s]*net.ipv6.conf.all.disable_ipv6
        replace: '#net.ipv6.conf.all.disable_ipv6'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92496-9
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_all_disable_ipv6

    - name: Ensure sysctl net.ipv6.conf.all.disable_ipv6 is set to 1
      sysctl:
        name: net.ipv6.conf.all.disable_ipv6
        value: '1'
        sysctl_file: /etc/sysctl.d/net_ipv6_conf_all_disable_ipv6.conf
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92496-9
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_all_disable_ipv6


    - name: List /etc/sysctl.d/*.conf files
      find:
        paths:
        - /run/sysctl.d/
        - /etc/sysctl.d/
        - /usr/local/lib/sysctl.d/
        - /lib/sysctl.d/
        contains: ^[\s]*net.ipv6.conf.default.disable_ipv6.*$
        patterns: '*.conf'
        file_type: any
      register: find_sysctl_d
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_default_disable_ipv6

    - name: Comment out any occurrences of net.ipv6.conf.default.disable_ipv6 from config
        files
      replace:
        path: '{{ item.path }}'
        regexp: ^[\s]*net.ipv6.conf.default.disable_ipv6
        replace: '#net.ipv6.conf.default.disable_ipv6'
      loop: '{{ find_sysctl_d.files }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_default_disable_ipv6

    - name: Comment out any occurrences of net.ipv6.conf.default.disable_ipv6 from /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: ^[\s]*net.ipv6.conf.default.disable_ipv6
        replace: '#net.ipv6.conf.default.disable_ipv6'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_default_disable_ipv6

    - name: Ensure sysctl net.ipv6.conf.default.disable_ipv6 is set to 1
      sysctl:
        name: net.ipv6.conf.default.disable_ipv6
        value: '1'
        sysctl_file: /etc/sysctl.d/net_ipv6_conf_default_disable_ipv6.conf
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - NIST-800-171-3.1.20
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - low_complexity
      - medium_disruption
      - medium_severity
      - reboot_required
      - sysctl_net_ipv6_conf_default_disable_ipv6


    - name: Ensure kernel module 'squashfs' is disabled
      lineinfile:
        create: true
        dest: /etc/modprobe.d/squashfs.conf
        regexp: install\s+squashfs
        line: install squashfs /bin/false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92452-2
      - NIST-800-171-3.4.6
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_squashfs_disabled
      - low_complexity
      - low_severity
      - medium_disruption
      - reboot_required

    - name: Ensure kernel module 'squashfs' is blacklisted
      lineinfile:
        create: true
        dest: /etc/modprobe.d/squashfs.conf
        regexp: ^blacklist squashfs$
        line: blacklist squashfs
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92452-2
      - NIST-800-171-3.4.6
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_squashfs_disabled
      - low_complexity
      - low_severity
      - medium_disruption
      - reboot_required


    - name: Ensure kernel module 'udf' is disabled
      lineinfile:
        create: true
        dest: /etc/modprobe.d/udf.conf
        regexp: install\s+udf
        line: install udf /bin/false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92453-0
      - NIST-800-171-3.4.6
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_udf_disabled
      - low_complexity
      - low_severity
      - medium_disruption
      - reboot_required

    - name: Ensure kernel module 'udf' is blacklisted
      lineinfile:
        create: true
        dest: /etc/modprobe.d/udf.conf
        regexp: ^blacklist udf$
        line: blacklist udf
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-92453-0
      - NIST-800-171-3.4.6
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - disable_strategy
      - kernel_module_udf_disabled
      - low_complexity
      - low_severity
      - medium_disruption
      - reboot_required


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-85825-8
      - CJIS-5.4.1.1
      - NIST-800-53-AU-11
      - NIST-800-53-CM-6(a)
      - PCI-DSS-Req-10.7
      - auditd_data_retention_max_log_file
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy



    - name: Configure auditd Max Log File Size
      lineinfile:
        dest: /etc/audit/auditd.conf
        regexp: ^\s*max_log_file\s*=\s*.*$
        line: max_log_file = {{ var_auditd_max_log_file }}
        state: present
        create: true
      when:
      - '"audit" in ansible_facts.packages'
      - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-85825-8
      - CJIS-5.4.1.1
      - NIST-800-53-AU-11
      - NIST-800-53-CM-6(a)
      - PCI-DSS-Req-10.7
      - auditd_data_retention_max_log_file
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy


